<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة البطاقات الوطنية المغربية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            font-family: 'Cairo', sans-serif;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.8s ease-in-out;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            color: #00695c;
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 40px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-filter-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
            background: #f9fafb;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-box, .filter-box {
            flex: 1;
            min-width: 250px;
        }

        .form-control, .form-select {
            padding: 12px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #00695c;
            box-shadow: 0 0 10px rgba(0, 105, 92, 0.2);
            outline: none;
        }

        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stats-box {
            flex: 1;
            text-align: center;
            font-size: 1.2rem;
            padding: 15px;
            border-radius: 10px;
            color: #fff;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stats-box:hover {
            transform: translateY(-5px);
        }

        .table-responsive {
            border-radius: 15px;
            overflow-x: auto;
            background: #fff;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .table {
            width: 100%;
            min-width: 1200px;
            margin-bottom: 0;
        }

        .table thead {
            background: linear-gradient(90deg, #004d40, #26a69a);
            color: #fff;
            font-weight: 600;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: center;
            vertical-align: middle;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table td.phone-number {
            text-align: left;
            direction: ltr;
            font-family: monospace;
        }

        .table td.created-at {
            white-space: normal;
            max-width: 200px;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: #e6f3f5;
            transform: scale(1.01);
        }

        .expired { background-color: #fee2e2; }
        .active { background-color: #e6ffe6; }
        .warning { background-color: #fff3e0; }

        .table img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #00695c;
            transition: transform 0.3s ease;
            display: block;
        }

        .table img:hover {
            transform: scale(1.1);
        }

        .btn {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00796b, #26a69a);
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: #fff;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c62828, #ef5350);
            color: #fff;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f57c00, #ff9800);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            filter: brightness(110%);
        }

        .no-results, .error-message {
            text-align: center;
            font-size: 1.3rem;
            padding: 25px;
            margin: 30px 0;
            border-radius: 12px;
            background: #f8f9fa;
            display: none;
        }

        .error-message {
            color: #d32f2f;
            background: #fee2e2;
        }

        .loading-spinner {
            text-align: center;
            margin: 40px 0;
            display: none;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #00695c;
        }

        .pagination .page-link {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            color: #00695c;
            font-weight: 600;
        }

        .pagination .page-item.active .page-link {
            background: #00695c;
            color: #fff;
        }

        .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            background: linear-gradient(90deg, #00695c, #4db6ac);
            color: #fff;
            border-bottom: none;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }

        .modal-body {
            padding: 25px;
            text-align: right;
        }

        .modal-body img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #00695c;
            margin: 0 auto 20px;
            display: block;
        }

        .modal-body .detail-item {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #374151;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }

        .modal-body .detail-item .phone-number {
            direction: ltr;
            font-family: monospace;
        }

        .delete-modal .modal-header {
            background: linear-gradient(135deg, #c62828, #ef5350);
        }

        .delete-modal .modal-body {
            text-align: center;
            font-size: 1.2rem;
            color: #374151;
            animation: shake 0.5s ease-in-out;
        }

        .save-modal .modal-header {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            max-width: 300px;
        }

        .notification.success {
            border-left: 5px solid #2e7d32;
        }

        .notification.warning {
            border-left: 5px solid #f57c00;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .table { min-width: unset; display: block; }
            .table thead { display: none; }
            .table tbody, .table tr { display: block; }
            .table tr { margin-bottom: 15px; padding: 10px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05); }
            .table td { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #e2e8f0; }
            .table td.phone-number, .table td.created-at { direction: ltr; justify-content: flex-start; }
            .table td::before { content: attr(data-label); font-weight: 600; color: #00695c; }
            .search-filter-container { flex-direction: column; }
            .stats-box { min-width: unset; width: 100%; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="animate__animated animate__fadeIn">نظام إدارة البطاقات الوطنية المغربية</h1>

        <div class="stats-container animate__animated animate__fadeIn">
            <div class="stats-box" style="background: #00796b;">إجمالي البطاقات: <span id="totalCards">0</span></div>
            <div class="stats-box" style="background: #2e7d32;">السارية: <span id="activeCards">0</span></div>
            <div class="stats-box" style="background: #c62828;">المنتهية: <span id="expiredCards">0</span></div>
            <div class="stats-box" style="background: #f57c00;">قريبة الانتهاء: <span id="expiringSoonCards">0</span></div>
        </div>

        <div class="search-filter-container animate__animated animate__fadeIn">
            <div class="search-box">
                <input type="text" id="search-input" class="form-control" placeholder="ابحث بالاسم أو رقم البطاقة...">
            </div>
            <div class="filter-box">
                <select id="filter-gender" class="form-select">
                    <option value="">جميع الجنس</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                </select>
            </div>
            <div class="filter-box">
                <select id="filter-status" class="form-select">
                    <option value="">جميع الحالات</option>
                    <option value="active">سارية</option>
                    <option value="expired">منتهية</option>
                    <option value="expiring-soon">قريبة الانتهاء</option>
                </select>
            </div>
        </div>

        <div class="table-responsive animate__animated animate__fadeIn">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>الصورة</th>
                        <th>الاسم الكامل</th>
                        <th>تاريخ الميلاد</th>
                        <th>الجنس</th>
                        <th>حالة الزواج</th>
                        <th>العنوان</th>
                        <th>رقم البطاقة</th>
                        <th>رقم الهاتف</th>
                        <th>تاريخ الإصدار</th>
                        <th>تاريخ الانتهاء</th>
                        <th>تاريخ الإدخال</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>

        <nav><ul class="pagination justify-content-center mt-3" id="pagination-controls"></ul></nav>

        <div class="d-flex justify-content-center flex-wrap gap-3 mt-3">
            <button id="export-excel-btn" class="btn btn-success"><i class="fas fa-download"></i> تصدير Excel</button>
            <button id="export-json-btn" class="btn btn-success"><i class="fas fa-file-export"></i> نسخ احتياطي (JSON)</button>
            <button id="import-btn" class="btn btn-warning"><i class="fas fa-file-import"></i> استيراد بيانات</button>
            <input type="file" id="import-file" accept=".json,.xlsx" style="display: none;">
            <button id="print-btn" class="btn btn-success"><i class="fas fa-print"></i> طباعة</button>
            <button id="refresh-btn" class="btn btn-success"><i class="fas fa-sync"></i> تحديث</button>
            <button class="btn btn-success" onclick="window.location.href='index.html'"><i class="fas fa-home"></i> الرئيسية</button>
        </div>

        <div id="no-results" class="no-results">لا توجد نتائج مطابقة</div>
        <div id="error-message" class="error-message">حدث خطأ أثناء جلب البيانات</div>
        <div id="loading-spinner" class="loading-spinner">
            <div class="spinner-border" role="status"><span class="visually-hidden">جارٍ التحميل...</span></div>
        </div>
    </div>

    <!-- نافذة التفاصيل -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailsModalLabel">تفاصيل المستخدم</h5>
                </div>
                <div class="modal-body" id="modalBodyContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal"><i class="fas fa-times"></i> إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة التعديل -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">تعديل البطاقة</h5>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-doc-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>الاسم الكامل</label>
                            <input type="text" id="edit-fullName" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>تاريخ الميلاد</label>
                            <input type="date" id="edit-birthDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>الجنس</label>
                            <select id="edit-gender" class="form-select" required>
                                <option value="male">ذكر</option>
                                <option value="female">أنثى</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>حالة الزواج</label>
                            <select id="edit-maritalStatus" class="form-select" required>
                                <option value="single">أعزب/عزباء</option>
                                <option value="married">متزوج/متزوجة</option>
                                <option value="divorced">مطلق/مطلقة</option>
                                <option value="widowed">أرمل/أرملة</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>العنوان</label>
                            <input type="text" id="edit-address" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>رقم الهاتف</label>
                            <input type="text" id="edit-phoneNumber" class="form-control" required dir="ltr">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>رقم البطاقة</label>
                            <input type="text" id="edit-idNumber" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>تاريخ الإصدار</label>
                            <input type="date" id="edit-issueDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>تاريخ الانتهاء</label>
                            <input type="date" id="edit-expiryDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>الصورة (رابط)</label>
                            <input type="text" id="edit-personalPhoto" class="form-control" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-success" id="save-edit-btn">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد الحذف -->
    <div class="modal fade delete-modal" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">تأكيد الحذف</h5>
                </div>
                <div class="modal-body">
                    <p><i class="fas fa-exclamation-triangle text-danger me-2"></i>هل أنت متأكد من حذف هذه البطاقة؟</p>
                    <p id="delete-user-name" class="fw-bold text-danger"></p>
                    <small class="text-muted">هذا الإجراء لا يمكن التراجع عنه!</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn"><i class="fas fa-trash-can"></i> حذف</button>
                </div>
            </div>
        </div>
    </div>

    <!-- إشعار -->
    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            deleteDoc, 
            updateDoc, 
            setDoc, 
            getDoc, 
            serverTimestamp,
            writeBatch,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDpYauuaSBRHFSOeykFiZai3BSPVXQ8CP0",
            authDomain: "new-project-d4813.firebaseapp.com",
            projectId: "new-project-d4813",
            storageBucket: "new-project-d4813.appspot.com",
            messagingSenderId: "1083380199863",
            appId: "1:1083380199863:web:004f2e1f639ff0a95e3832",
            measurementId: "G-1XJJGHR2W4"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // عناصر DOM
        const userList = document.getElementById('user-list');
        const noResults = document.getElementById('no-results');
        const errorMessage = document.getElementById('error-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const searchInput = document.getElementById('search-input');
        const filterGender = document.getElementById('filter-gender');
        const filterStatus = document.getElementById('filter-status');
        const paginationControls = document.getElementById('pagination-controls');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const importBtn = document.getElementById('import-btn');
        const importFile = document.getElementById('import-file');
        const printBtn = document.getElementById('print-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const totalCards = document.getElementById('totalCards');
        const activeCards = document.getElementById('activeCards');
        const expiredCards = document.getElementById('expiredCards');
        const expiringSoonCards = document.getElementById('expiringSoonCards');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const notification = document.getElementById('notification');

        // الثوابت والمتغيرات العامة
        const ITEMS_PER_PAGE = 10;
        const EXPIRY_WARNING_DAYS = 30;
        let currentPage = 1;
        let allUsers = [];
        let deleteId = null;

        // ========== دوال المساعدة ==========

        // تنظيف المدخلات لمنع هجمات XSS
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // تنسيق التاريخ لعرضه بشكل مقروء
        function formatDate(dateInput) {
            if (!dateInput) return 'غير محدد';
            
            try {
                const date = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
                if (isNaN(date.getTime())) return 'غير محدد';
                
                return date.toLocaleString('ar-MA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                return 'غير محدد';
            }
        }

        // تنسيق الجنس
        function formatGender(gender) {
            return gender === 'male' ? 'ذكر' : gender === 'female' ? 'أنثى' : sanitizeInput(gender) || 'غير محدد';
        }

        // تنسيق حالة الزواج
        function formatMaritalStatus(status) {
            switch (status) {
                case 'single': return 'أعزب/عزباء';
                case 'married': return 'متزوج/متزوجة';
                case 'divorced': return 'مطلق/مطلقة';
                case 'widowed': return 'أرمل/أرملة';
                default: return sanitizeInput(status) || 'غير محدد';
            }
        }

        // تنسيق رقم الهاتف
        function formatPhoneNumber(phone) {
            if (!phone) return 'غير محدد';
            const cleanPhone = phone.replace(/[^0-9+]/g, '');
            if (cleanPhone.match(/^\+212[5-7][0-9]{8}$/)) {
                return `${cleanPhone.slice(0, 4)} ${cleanPhone.slice(4, 7)} ${cleanPhone.slice(7)}`;
            }
            return sanitizeInput(phone) || 'غير محدد';
        }

        // عرض الإشعارات
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 5000);
        }

        // تأخير تنفيذ الدالة لتقليل عدد الطلبات
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        // التحقق من صلاحية البطاقات وإظهار تحذيرات للبطاقات القريبة من الانتهاء
        function checkExpiryWarnings(users) {
            const today = new Date();
            const warningDate = new Date(today);
            warningDate.setDate(today.getDate() + EXPIRY_WARNING_DAYS);

            users.forEach(user => {
                try {
                    const expiryDate = new Date(user.expiryDateRaw);
                    if (expiryDate > today && expiryDate <= warningDate) {
                        showNotification(`تنبيه: البطاقة لـ "${user.fullName}" ستنتهي صلاحيتها في ${user.expiryDate}`, 'warning');
                    }
                } catch (e) {
                    console.error('خطأ في تحقق تاريخ الانتهاء:', e);
                }
            });
        }

        // ========== دوال عرض البيانات ==========

        // عرض تفاصيل المستخدم في نافذة منبثقة
        function showUserDetails(user) {
            const modalBodyContent = document.getElementById('modalBodyContent');
            modalBodyContent.innerHTML = `
                <img src="${user.personalPhoto}" alt="الصورة" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
                <div class="detail-item"><span><i class="fas fa-user"></i> الاسم الكامل:</span> <strong>${user.fullName}</strong></div>
                <div class="detail-item"><span><i class="fas fa-calendar-alt"></i> تاريخ الميلاد:</span> <strong>${user.birthDate}</strong></div>
                <div class="detail-item"><span><i class="fas fa-venus-mars"></i> الجنس:</span> <strong>${formatGender(user.gender)}</strong></div>
                <div class="detail-item"><span><i class="fas fa-ring"></i> حالة الزواج:</span> <strong>${formatMaritalStatus(user.maritalStatus)}</strong></div>
                <div class="detail-item"><span><i class="fas fa-map-marker-alt"></i> العنوان:</span> <strong>${user.address}</strong></div>
                <div class="detail-item"><span><i class="fas fa-phone"></i> رقم الهاتف:</span> <strong class="phone-number">${formatPhoneNumber(user.phoneNumber)}</strong></div>
                <div class="detail-item"><span><i class="fas fa-id-card"></i> رقم البطاقة:</span> <strong>${user.idNumber}</strong></div>
                <div class="detail-item"><span><i class="fas fa-calendar-check"></i> تاريخ الإصدار:</span> <strong>${user.issueDate}</strong></div>
                <div class="detail-item"><span><i class="fas fa-calendar-times"></i> تاريخ الانتهاء:</span> <strong>${user.expiryDate}</strong></div>
                <div class="detail-item"><span><i class="fas fa-clock"></i> تاريخ الإدخال:</span> <strong>${user.createdAt}</strong></div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        }

        // تحميل بيانات المستخدم في نموذج التعديل
        function editUser(docId) {
            const user = allUsers.find(u => u.docId === docId);
            if (!user) {
                showNotification('لم يتم العثور على المستخدم', 'warning');
                return;
            }

            document.getElementById('edit-doc-id').value = docId;
            document.getElementById('edit-fullName').value = user.fullName;
            document.getElementById('edit-birthDate').value = user.birthDateRaw;
            document.getElementById('edit-gender').value = user.gender;
            document.getElementById('edit-maritalStatus').value = user.maritalStatus;
            document.getElementById('edit-address').value = user.address;
            document.getElementById('edit-phoneNumber').value = user.phoneNumber;
            document.getElementById('edit-idNumber').value = user.idNumber;
            document.getElementById('edit-issueDate').value = user.issueDateRaw;
            document.getElementById('edit-expiryDate').value = user.expiryDateRaw;
            document.getElementById('edit-personalPhoto').value = user.personalPhoto;
            
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        // حفظ التعديلات على بيانات المستخدم
        async function saveEdit() {
            const docId = document.getElementById('edit-doc-id').value;
            const newIdNumber = sanitizeInput(document.getElementById('edit-idNumber').value);
            
            if (!docId || !newIdNumber) {
                showNotification('رقم البطاقة مطلوب', 'warning');
                return;
            }

            const updatedData = {
                fullName: sanitizeInput(document.getElementById('edit-fullName').value),
                birthDate: document.getElementById('edit-birthDate').value,
                gender: document.getElementById('edit-gender').value,
                maritalStatus: document.getElementById('edit-maritalStatus').value,
                address: sanitizeInput(document.getElementById('edit-address').value),
                phoneNumber: sanitizeInput(document.getElementById('edit-phoneNumber').value),
                idNumber: newIdNumber,
                issueDate: document.getElementById('edit-issueDate').value,
                expiryDate: document.getElementById('edit-expiryDate').value,
                personalPhoto: sanitizeInput(document.getElementById('edit-personalPhoto').value),
                updatedAt: serverTimestamp()
            };

            // التحقق من البيانات المطلوبة
            if (Object.values(updatedData).some(val => !val)) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
                return;
            }

            try {
                const oldUser = allUsers.find(u => u.docId === docId);
                
                // إذا تغير رقم البطاقة، نتحقق من عدم وجود تكرار
                if (oldUser.idNumber !== updatedData.idNumber) {
                    const idCheck = await getDoc(doc(db, 'national_id_data', updatedData.idNumber));
                    if (idCheck.exists()) {
                        showNotification('رقم البطاقة موجود مسبقًا!', 'warning');
                        return;
                    }
                    
                    // إنشاء وثيقة جديدة وحذف القديمة في عملية واحدة
                    const batch = writeBatch(db);
                    batch.set(doc(db, 'national_id_data', updatedData.idNumber), { 
                        ...updatedData, 
                        createdAt: oldUser.createdAtRaw || serverTimestamp() 
                    });
                    batch.delete(doc(db, 'national_id_data', docId));
                    await batch.commit();
                } else {
                    // تحديث الوثيقة الحالية إذا لم يتغير رقم البطاقة
                    await updateDoc(doc(db, 'national_id_data', docId), updatedData);
                }
                
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                fetchUsers();
                showNotification('تم تحديث بيانات البطاقة بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في حفظ التعديلات:', error);
                showNotification('حدث خطأ أثناء حفظ التعديلات', 'error');
            }
        }

        // تأكيد حذف المستخدم
        function confirmDeleteUser(docId) {
            const user = allUsers.find(u => u.docId === docId);
            if (!user) {
                showNotification('لم يتم العثور على المستخدم', 'warning');
                return;
            }
            
            deleteId = docId;
            document.getElementById('delete-user-name').textContent = user.fullName;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        // حذف المستخدم بعد التأكيد
        async function deleteUser() {
            if (!deleteId) return;
            
            try {
                await deleteDoc(doc(db, 'national_id_data', deleteId));
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                fetchUsers();
                showNotification('تم حذف البطاقة بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في حذف البطاقة:', error);
                showNotification('حدث خطأ أثناء حذف البطاقة', 'error');
            } finally {
                deleteId = null;
            }
        }

        // جلب بيانات المستخدمين من Firebase
        async function fetchUsers(searchQuery = '', genderFilter = '', page = 1) {
            loadingSpinner.style.display = 'block';
            errorMessage.style.display = 'none';
            noResults.style.display = 'none';
            userList.innerHTML = '';

            try {
                const querySnapshot = await getDocs(collection(db, 'national_id_data'));
                allUsers = [];

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    allUsers.push({
                        docId: doc.id,
                        personalPhoto: data.personalPhoto || 'https://via.placeholder.com/90',
                        fullName: sanitizeInput(data.fullName) || 'غير محدد',
                        birthDate: formatDate(data.birthDate),
                        birthDateRaw: data.birthDate || '',
                        gender: data.gender || 'غير محدد',
                        maritalStatus: data.maritalStatus || 'غير محدد',
                        address: sanitizeInput(data.address) || 'غير محدد',
                        idNumber: sanitizeInput(data.idNumber) || 'غير محدد',
                        phoneNumber: sanitizeInput(data.phoneNumber) || 'غير محدد',
                        issueDate: formatDate(data.issueDate),
                        issueDateRaw: data.issueDate || '',
                        expiryDate: formatDate(data.expiryDate),
                        expiryDateRaw: data.expiryDate || '',
                        createdAt: formatDate(data.createdAt || new Date()),
                        createdAtRaw: data.createdAt || serverTimestamp()
                    });
                });

                // التحقق من صلاحية البطاقات وإظهار التحذيرات
                checkExpiryWarnings(allUsers);

                // تصفية البيانات حسب البحث والفلتر
                const filteredUsers = allUsers.filter(user => {
                    const isExpired = new Date(user.expiryDateRaw) < new Date();
                    const isExpiringSoon = new Date(user.expiryDateRaw) > new Date() && 
                                          new Date(user.expiryDateRaw) <= new Date(Date.now() + EXPIRY_WARNING_DAYS * 24 * 60 * 60 * 1000);
                    
                    const matchesSearch = searchQuery === '' || 
                                         user.fullName.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                         user.idNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                         user.phoneNumber.toLowerCase().includes(searchQuery.toLowerCase());
                    
                    const matchesGender = !genderFilter || user.gender === genderFilter;
                    
                    const matchesStatus = !filterStatus.value || 
                                         (filterStatus.value === 'active' && !isExpired && !isExpiringSoon) || 
                                         (filterStatus.value === 'expired' && isExpired) || 
                                         (filterStatus.value === 'expiring-soon' && isExpiringSoon);
                    
                    return matchesSearch && matchesGender && matchesStatus;
                });

                // تحديث الإحصائيات
                updateStatistics(filteredUsers);

                // التقسيم إلى صفحات
                const startIdx = (page - 1) * ITEMS_PER_PAGE;
                const paginatedUsers = filteredUsers.slice(startIdx, startIdx + ITEMS_PER_PAGE);

                if (paginatedUsers.length === 0) {
                    noResults.style.display = 'block';
                } else {
                    renderUsersTable(paginatedUsers);
                }

                // إنشاء عناصر التصفح بين الصفحات
                generatePagination(filteredUsers.length, page);
            } catch (error) {
                console.error('خطأ في جلب البيانات:', error);
                errorMessage.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // تحديث إحصائيات البطاقات
        function updateStatistics(users) {
            const today = new Date();
            const warningDate = new Date(today);
            warningDate.setDate(today.getDate() + EXPIRY_WARNING_DAYS);

            totalCards.textContent = users.length;
            activeCards.textContent = users.filter(u => {
                try {
                    const expiryDate = new Date(u.expiryDateRaw);
                    return expiryDate >= today && expiryDate > warningDate;
                } catch (e) {
                    return false;
                }
            }).length;
            
            expiredCards.textContent = users.filter(u => {
                try {
                    return new Date(u.expiryDateRaw) < today;
                } catch (e) {
                    return false;
                }
            }).length;
            
            expiringSoonCards.textContent = users.filter(u => {
                try {
                    const expiryDate = new Date(u.expiryDateRaw);
                    return expiryDate > today && expiryDate <= warningDate;
                } catch (e) {
                    return false;
                }
            }).length;
        }

        // عرض المستخدمين في الجدول
        function renderUsersTable(users) {
            users.forEach(user => {
                const isExpired = new Date(user.expiryDateRaw) < new Date();
                const isExpiringSoon = new Date(user.expiryDateRaw) > new Date() && 
                                      new Date(user.expiryDateRaw) <= new Date(Date.now() + EXPIRY_WARNING_DAYS * 24 * 60 * 60 * 1000);
                
                const row = document.createElement('tr');
                row.classList.add(isExpired ? 'expired' : isExpiringSoon ? 'warning' : 'active');
                row.innerHTML = `
                    <td data-label="الصورة"><img src="${user.personalPhoto}" alt="الصورة" loading="lazy" onerror="this.src='https://via.placeholder.com/90'"></td>
                    <td data-label="الاسم الكامل">${user.fullName}</td>
                    <td data-label="تاريخ الميلاد">${user.birthDate}</td>
                    <td data-label="الجنس">${formatGender(user.gender)}</td>
                    <td data-label="حالة الزواج">${formatMaritalStatus(user.maritalStatus)}</td>
                    <td data-label="العنوان">${user.address}</td>
                    <td data-label="رقم البطاقة">${user.idNumber}</td>
                    <td data-label="رقم الهاتف" class="phone-number">${formatPhoneNumber(user.phoneNumber)}</td>
                    <td data-label="تاريخ الإصدار">${user.issueDate}</td>
                    <td data-label="تاريخ الانتهاء">${user.expiryDate}</td>
                    <td data-label="تاريخ الإدخال" class="created-at">${user.createdAt}</td>
                    <td data-label="الحالة">${isExpired ? 'منتهية' : isExpiringSoon ? 'قريبة الانتهاء' : 'سارية'}</td>
                    <td data-label="الإجراءات">
                        <button class="btn btn-sm btn-primary view-details"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-success edit-user"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-user"><i class="fas fa-trash-can"></i></button>
                    </td>
                `;
                
                // إضافة معالجات الأحداث للأزرار
                row.querySelector('.view-details').addEventListener('click', () => showUserDetails(user));
                row.querySelector('.edit-user').addEventListener('click', () => editUser(user.docId));
                row.querySelector('.delete-user').addEventListener('click', () => confirmDeleteUser(user.docId));
                
                userList.appendChild(row);
            });
        }

        // إنشاء عناصر التصفح بين الصفحات
        function generatePagination(totalItems, currentPage) {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (totalPages <= 1) return;

            // زر الصفحة السابقة
            if (currentPage > 1) {
                const prevItem = document.createElement('li');
                prevItem.classList.add('page-item');
                prevItem.innerHTML = `<a class="page-link" href="#" aria-label="السابق"><i class="fas fa-chevron-right"></i></a>`;
                prevItem.querySelector('.page-link').addEventListener('click', e => {
                    e.preventDefault();
                    fetchUsers(searchInput.value, filterGender.value, currentPage - 1);
                });
                paginationControls.appendChild(prevItem);
            }

            // أرقام الصفحات
            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                pageItem.classList.add('page-item');
                if (i === currentPage) pageItem.classList.add('active');
                pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageItem.querySelector('.page-link').addEventListener('click', e => {
                    e.preventDefault();
                    fetchUsers(searchInput.value, filterGender.value, i);
                });
                paginationControls.appendChild(pageItem);
            }

            // زر الصفحة التالية
            if (currentPage < totalPages) {
                const nextItem = document.createElement('li');
                nextItem.classList.add('page-item');
                nextItem.innerHTML = `<a class="page-link" href="#" aria-label="التالي"><i class="fas fa-chevron-left"></i></a>`;
                nextItem.querySelector('.page-link').addEventListener('click', e => {
                    e.preventDefault();
                    fetchUsers(searchInput.value, filterGender.value, currentPage + 1);
                });
                paginationControls.appendChild(nextItem);
            }
        }

        // ========== دوال التصدير والاستيراد ==========

        // تصدير البيانات إلى Excel
        exportExcelBtn.addEventListener('click', () => {
            if (allUsers.length === 0) {
                showNotification('لا توجد بيانات للتصدير', 'warning');
                return;
            }

            try {
                const ws = XLSX.utils.json_to_sheet(allUsers.map(user => ({
                    'الاسم الكامل': user.fullName,
                    'تاريخ الميلاد': user.birthDate,
                    'الجنس': formatGender(user.gender),
                    'حالة الزواج': formatMaritalStatus(user.maritalStatus),
                    'العنوان': user.address,
                    'رقم البطاقة': user.idNumber,
                    'رقم الهاتف': formatPhoneNumber(user.phoneNumber),
                    'تاريخ الإصدار': user.issueDate,
                    'تاريخ الانتهاء': user.expiryDate,
                    'تاريخ الإدخال': user.createdAt
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "البطاقات_الوطنية");
                XLSX.writeFile(wb, "البطاقات_الوطنية.xlsx");
                showNotification('تم تصدير البيانات إلى ملف Excel بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في التصدير إلى Excel:', error);
                showNotification('حدث خطأ أثناء التصدير إلى Excel', 'error');
            }
        });

        // تصدير البيانات إلى JSON
        exportJsonBtn.addEventListener('click', () => {
            if (allUsers.length === 0) {
                showNotification('لا توجد بيانات للتصدير', 'warning');
                return;
            }

            try {
                const jsonData = JSON.stringify(allUsers, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'البطاقات_الوطنية_نسخة_احتياطية.json';
                a.click();
                URL.revokeObjectURL(url);
                showNotification('تم إنشاء نسخة احتياطية بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير JSON:', error);
                showNotification('حدث خطأ أثناء إنشاء النسخة الاحتياطية', 'error');
            }
        });

        // استيراد البيانات من ملف
        importBtn.addEventListener('click', () => {
            importFile.click();
        });

        importFile.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                loadingSpinner.style.display = 'block';
                
                if (file.name.endsWith('.json')) {
                    await importFromJson(file);
                } else if (file.name.endsWith('.xlsx')) {
                    await importFromExcel(file);
                } else {
                    showNotification('نوع الملف غير مدعوم. يرجى استخدام ملف JSON أو Excel', 'warning');
                }
            } catch (error) {
                console.error('خطأ في الاستيراد:', error);
                showNotification('حدث خطأ أثناء استيراد البيانات', 'error');
            } finally {
                importFile.value = '';
                loadingSpinner.style.display = 'none';
            }
        });

        // استيراد البيانات من ملف JSON
        async function importFromJson(file) {
            const text = await file.text();
            const importedData = JSON.parse(text);
            let addedCount = 0;
            let skippedCount = 0;

            // إنشاء مجموعة من أرقام البطاقات الموجودة لتجنب التكرار
            const existingIds = new Set(allUsers.map(user => user.idNumber));

            // استخدام الدفعة (Batch) لتحسين الأداء
            const batch = writeBatch(db);
            const batchSize = 500;
            let currentBatchSize = 0;

            for (const user of importedData) {
                if (!user.idNumber) {
                    skippedCount++;
                    continue;
                }

                if (existingIds.has(user.idNumber)) {
                    skippedCount++;
                    continue;
                }

                const userDocRef = doc(db, 'national_id_data', user.idNumber);
                const sanitizedUser = {
                    fullName: sanitizeInput(user.fullName) || 'غير محدد',
                    birthDate: user.birthDateRaw || '',
                    gender: user.gender || 'غير محدد',
                    maritalStatus: user.maritalStatus || 'غير محدد',
                    address: sanitizeInput(user.address) || 'غير محدد',
                    phoneNumber: sanitizeInput(user.phoneNumber) || 'غير محدد',
                    idNumber: sanitizeInput(user.idNumber) || 'غير محدد',
                    issueDate: user.issueDateRaw || '',
                    expiryDate: user.expiryDateRaw || '',
                    personalPhoto: user.personalPhoto || 'https://via.placeholder.com/90',
                    createdAt: user.createdAtRaw || serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                batch.set(userDocRef, sanitizedUser);
                addedCount++;
                existingIds.add(user.idNumber);
                currentBatchSize++;

                // تنفيذ الدفعة عند الوصول إلى الحجم المحدد
                if (currentBatchSize >= batchSize) {
                    await batch.commit();
                    currentBatchSize = 0;
                }
            }

            // تنفيذ أي عناصر متبقية في الدفعة
            if (currentBatchSize > 0) {
                await batch.commit();
            }

            fetchUsers();
            showNotification(
                `تم استيراد البيانات بنجاح: ${addedCount} إضافة، ${skippedCount} تخطي (مكرر أو بدون رقم بطاقة)`,
                'success'
            );
        }

        // استيراد البيانات من ملف Excel
        async function importFromExcel(file) {
            const reader = new FileReader();
            
            return new Promise((resolve, reject) => {
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        let addedCount = 0;
                        let skippedCount = 0;

                        // إنشاء مجموعة من أرقام البطاقات الموجودة لتجنب التكرار
                        const existingIds = new Set(allUsers.map(user => user.idNumber));

                        // استخدام الدفعة (Batch) لتحسين الأداء
                        const batch = writeBatch(db);
                        const batchSize = 500;
                        let currentBatchSize = 0;

                        for (const user of jsonData) {
                            if (!user['رقم البطاقة']) {
                                skippedCount++;
                                continue;
                            }

                            const idNumber = sanitizeInput(user['رقم البطاقة']);
                            if (existingIds.has(idNumber)) {
                                skippedCount++;
                                continue;
                            }

                            const userDocRef = doc(db, 'national_id_data', idNumber);
                            const sanitizedUser = {
                                fullName: sanitizeInput(user['الاسم الكامل']) || 'غير محدد',
                                birthDate: user['تاريخ الميلاد'] || '',
                                gender: user['الجنس'] === 'ذكر' ? 'male' : user['الجنس'] === 'أنثى' ? 'female' : 'غير محدد',
                                maritalStatus: user['حالة الزواج'] === 'أعزب/عزباء' ? 'single' : 
                                              user['حالة الزواج'] === 'متزوج/متزوجة' ? 'married' : 
                                              user['حالة الزواج'] === 'مطلق/مطلقة' ? 'divorced' : 
                                              user['حالة الزواج'] === 'أرمل/أرملة' ? 'widowed' : 'غير محدد',
                                address: sanitizeInput(user['العنوان']) || 'غير محدد',
                                phoneNumber: sanitizeInput(user['رقم الهاتف']) || 'غير محدد',
                                idNumber: idNumber,
                                issueDate: user['تاريخ الإصدار'] || '',
                                expiryDate: user['تاريخ الانتهاء'] || '',
                                personalPhoto: 'https://via.placeholder.com/90',
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            batch.set(userDocRef, sanitizedUser);
                            addedCount++;
                            existingIds.add(idNumber);
                            currentBatchSize++;

                            // تنفيذ الدفعة عند الوصول إلى الحجم المحدد
                            if (currentBatchSize >= batchSize) {
                                await batch.commit();
                                currentBatchSize = 0;
                            }
                        }

                        // تنفيذ أي عناصر متبقية في الدفعة
                        if (currentBatchSize > 0) {
                            await batch.commit();
                        }

                        fetchUsers();
                        showNotification(
                            `تم استيراد البيانات من Excel بنجاح: ${addedCount} إضافة، ${skippedCount} تخطي (مكرر أو بدون رقم بطاقة)`,
                            'success'
                        );
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // ========== معالجات الأحداث ==========

        // طباعة البيانات
        printBtn.addEventListener('click', () => {
            if (allUsers.length === 0) {
                showNotification('لا توجد بيانات للطباعة', 'warning');
                return;
            }

            const printContent = document.querySelector('.table-responsive').outerHTML;
            const win = window.open('', '', 'height=500,width=800');
            win.document.write('<html><head><title>طباعة البطاقات الوطنية</title>');
            win.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            win.document.write('<style>body { font-family: "Cairo", sans-serif; direction: rtl; } .expired { background-color: #fee2e2; } .active { background-color: #e6ffe6; } .warning { background-color: #fff3e0; } img { width: 80px; height: 80px; } .phone-number, .created-at { direction: ltr; font-family: monospace; text-align: left; } .created-at { white-space: normal; max-width: 200px; }</style>');
            win.document.write('</head><body>');
            win.document.write(printContent);
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        });

        // تحديث البيانات
        refreshBtn.addEventListener('click', () => {
            fetchUsers(searchInput.value, filterGender.value, currentPage);
            showNotification('تم تحديث البيانات', 'success');
        });

        // حفظ التعديلات
        saveEditBtn.addEventListener('click', saveEdit);

        // تأكيد الحذف
        confirmDeleteBtn.addEventListener('click', deleteUser);

        // البحث والتصفية
        searchInput.addEventListener('input', debounce(() => {
            currentPage = 1;
            fetchUsers(searchInput.value, filterGender.value, currentPage);
        }, 300));

        filterGender.addEventListener('change', () => {
            currentPage = 1;
            fetchUsers(searchInput.value, filterGender.value, currentPage);
        });

        filterStatus.addEventListener('change', () => {
            currentPage = 1;
            fetchUsers(searchInput.value, filterGender.value, currentPage);
        });

        // تحميل البيانات الأولية
        fetchUsers();
    </script>
</body>
</html>