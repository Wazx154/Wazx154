<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض معلومات البطاقة الوطنية المغربية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* الأنماط السابقة بدون تغيير */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            font-family: 'Cairo', sans-serif;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.8s ease-in-out;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            color: #00695c;
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 40px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-filter-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            background: #f9fafb;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-box, .filter-box {
            flex: 1;
            min-width: 250px;
        }

        .form-control, .form-select {
            padding: 12px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #00695c;
            box-shadow: 0 0 10px rgba(0, 105, 92, 0.2);
            outline: none;
        }

        .form-control::placeholder {
            font-size: 1rem;
            color: #6b7280;
        }

        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stats-box {
            flex: 1;
            text-align: center;
            font-size: 1.2rem;
            padding: 15px;
            border-radius: 10px;
            color: #fff;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stats-box:hover {
            transform: translateY(-5px);
        }

        .table-responsive {
            border-radius: 15px;
            overflow-x: auto;
            background: #fff;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .table {
            width: 100%;
            min-width: 1200px;
            margin-bottom: 0;
        }

        .table thead {
            background: linear-gradient(90deg, #004d40, #26a69a);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: center;
            vertical-align: middle;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: #e6f3f5;
            transform: scale(1.01);
        }

        .expired { background-color: #fee2e2; }
        .active { background-color: #e6ffe6; }

        .table img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #00695c;
            transition: transform 0.3s ease;
        }

        .table img:hover {
            transform: scale(1.1);
        }

        .phone-number {
            font-family: monospace;
            direction: ltr;
            display: inline-block;
            padding: 5px 10px;
            background: #e6f3f5;
            border-radius: 5px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00796b, #26a69a);
            color: #fff;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #004d40, #00796b);
        }

        .btn-success, .btn-home, .btn-refresh, .btn-print {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: #fff;
            margin-left: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c62828, #ef5350);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            filter: brightness(110%);
        }

        .no-results, .error-message {
            text-align: center;
            font-size: 1.3rem;
            padding: 25px;
            margin: 30px 0;
            border-radius: 12px;
            background: #f8f9fa;
            display: none;
        }

        .error-message {
            color: #d32f2f;
            background: #fee2e2;
        }

        .loading-spinner {
            text-align: center;
            margin: 40px 0;
            display: none;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #00695c;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .pagination .page-link {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            color: #00695c;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination .page-link:hover {
            background: #e6f3f5;
        }

        .pagination .page-item.active .page-link {
            background: #00695c;
            color: #fff;
        }

        .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            background: linear-gradient(90deg, #00695c, #4db6ac);
            color: #fff;
            border-bottom: none;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        .modal-body {
            padding: 25px;
            text-align: right;
        }

        .modal-body img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #00695c;
            margin: 0 auto 20px;
            display: block;
            transition: transform 0.3s ease;
        }

        .modal-body img:hover {
            transform: scale(1.05);
        }

        .modal-body .detail-item {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #374151;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .modal-body .detail-item i {
            margin-left: 10px;
            color: #4db6ac;
        }

        .modal-body .detail-item strong {
            color: #00695c;
            font-weight: 600;
            margin-left: 10px;
        }

        .delete-modal .modal-header {
            background: linear-gradient(135deg, #c62828, #ef5350);
        }

        .delete-modal .modal-body, .save-modal .modal-body {
            text-align: center;
            font-size: 1.2rem;
            color: #374151;
        }

        .save-modal .modal-header {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
        }

        @media (max-width: 768px) {
            .table { min-width: unset; display: block; }
            .table thead { display: none; }
            .table tbody, .table tr { display: block; }
            .table tr { margin-bottom: 15px; padding: 10px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05); }
            .table td { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #e2e8f0; }
            .table td::before { content: attr(data-label); font-weight: 600; color: #00695c; }
            .search-filter-container { flex-direction: column; }
            .btn-success, .btn-home, .btn-refresh, .btn-print { margin: 10px auto; display: block; }
            .stats-box { min-width: unset; width: 100%; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="animate__animated animate__fadeIn">عرض معلومات البطاقة الوطنية المغربية</h1>

        <!-- إحصائيات سريعة -->
        <div class="stats-container animate__animated animate__fadeIn">
            <div class="stats-box" style="background: #00796b;">إجمالي البطاقات: <span id="totalCards">0</span></div>
            <div class="stats-box" style="background: #2e7d32;">السارية: <span id="activeCards">0</span></div>
            <div class="stats-box" style="background: #c62828;">المنتهية: <span id="expiredCards">0</span></div>
        </div>

        <!-- فلاتر البحث -->
        <div class="search-filter-container animate__animated animate__fadeIn">
            <div class="search-box">
                <input type="text" id="search-input" class="form-control" placeholder="ابحث بالاسم أو رقم البطاقة أو الهاتف...">
            </div>
            <div class="filter-box">
                <select id="filter-gender" class="form-select">
                    <option value="">جميع الجنس</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                </select>
            </div>
            <div class="filter-box">
                <select id="filter-status" class="form-select">
                    <option value="">جميع الحالات</option>
                    <option value="active">سارية</option>
                    <option value="expired">منتهية</option>
                </select>
            </div>
        </div>

        <div class="table-responsive animate__animated animate__fadeIn">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">الصورة</th>
                        <th onclick="sortTable(1)">الاسم الكامل <span>↑↓</span></th>
                        <th onclick="sortTable(2)">تاريخ الميلاد <span>↑↓</span></th>
                        <th onclick="sortTable(3)">الجنس <span>↑↓</span></th>
                        <th onclick="sortTable(4)">العنوان <span>↑↓</span></th>
                        <th onclick="sortTable(5)">رقم البطاقة <span>↑↓</span></th>
                        <th onclick="sortTable(6)">رقم الهاتف <span>↑↓</span></th>
                        <th onclick="sortTable(7)">تاريخ الإصدار <span>↑↓</span></th>
                        <th onclick="sortTable(8)">تاريخ الانتهاء <span>↑↓</span></th>
                        <th onclick="sortTable(9)">تاريخ الإدخال <span>↑↓</span></th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>

        <nav><ul class="pagination" id="pagination-controls"></ul></nav>

        <div class="d-flex justify-content-center flex-wrap gap-3 mt-3">
            <button id="export-excel-btn" class="btn btn-success"><i class="fas fa-download"></i> تصدير Excel</button>
            <button id="print-btn" class="btn btn-print"><i class="fas fa-print"></i> طباعة</button>
            <button id="refresh-btn" class="btn btn-refresh"><i class="fas fa-sync"></i> تحديث</button>
            <button id="home-btn" class="btn btn-home" onclick="window.location.href='index.html'"><i class="fas fa-home"></i> الصفحة الرئيسية</button>
        </div>

        <div id="no-results" class="no-results">لا توجد نتائج مطابقة</div>
        <div id="error-message" class="error-message">حدث خطأ أثناء جلب البيانات</div>
        <div id="loading-spinner" class="loading-spinner">
            <div class="spinner-border" role="status"><span class="visually-hidden">جارٍ التحميل...</span></div>
        </div>
    </div>

    <!-- نافذة التفاصيل -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailsModalLabel">تفاصيل المستخدم</h5>
                </div>
                <div class="modal-body" id="modalBodyContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal"><i class="fas fa-times"></i> إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة التعديل -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">تعديل البطاقة</h5>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-doc-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>الاسم الكامل</label>
                            <input type="text" id="edit-fullName" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>تاريخ الميلاد</label>
                            <input type="date" id="edit-birthDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>الجنس</label>
                            <select id="edit-gender" class="form-select" required>
                                <option value="male">ذكر</option>
                                <option value="female">أنثى</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>العنوان</label>
                            <input type="text" id="edit-address" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>رقم الهاتف</label>
                            <input type="text" id="edit-phoneNumber" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>رقم البطاقة</label>
                            <input type="text" id="edit-idNumber" class="form-control" required> <!-- إزالة disabled -->
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>تاريخ الإصدار</label>
                            <input type="date" id="edit-issueDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>تاريخ الانتهاء</label>
                            <input type="date" id="edit-expiryDate" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>الصورة الشخصية (رابط)</label>
                            <input type="text" id="edit-personalPhoto" class="form-control" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-success" id="save-edit-btn">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد الحذف -->
    <div class="modal fade delete-modal" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">تأكيد الحذف</h5>
                </div>
                <div class="modal-body">
                    <p>هل أنت متأكد من حذف هذه البطاقة؟</p>
                    <p id="delete-user-name" class="fw-bold text-danger"></p>
                    <small class="text-muted">هذا الإجراء لا يمكن التراجع عنه!</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">حذف</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد الحفظ -->
    <div class="modal fade save-modal" id="saveConfirmModal" tabindex="-1" aria-labelledby="saveConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveConfirmModalLabel">تم الحفظ بنجاح</h5>
                </div>
                <div class="modal-body">
                    <p>تم حفظ التعديلات على البطاقة بنجاح!</p>
                    <p id="save-user-name" class="fw-bold text-success"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDpYauuaSBRHFSOeykFiZai3BSPVXQ8CP0",
            authDomain: "new-project-d4813.firebaseapp.com",
            projectId: "new-project-d4813",
            storageBucket: "new-project-d4813.appspot.com",
            messagingSenderId: "1083380199863",
            appId: "1:1083380199863:web:004f2e1f639ff0a95e3832",
            measurementId: "G-1XJJGHR2W4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // العناصر في DOM
        const userList = document.getElementById('user-list');
        const noResults = document.getElementById('no-results');
        const errorMessage = document.getElementById('error-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const searchInput = document.getElementById('search-input');
        const filterGender = document.getElementById('filter-gender');
        const filterStatus = document.getElementById('filter-status');
        const paginationControls = document.getElementById('pagination-controls');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const printBtn = document.getElementById('print-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const totalCards = document.getElementById('totalCards');
        const activeCards = document.getElementById('activeCards');
        const expiredCards = document.getElementById('expiredCards');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        const itemsPerPage = 10;
        let currentPage = 1;
        let allUsers = [];
        let sortColumn = 1;
        let sortDirection = 1;
        let deleteId = null;

        // دالة لتنظيف المدخلات
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input || '';
            return div.innerHTML;
        }

        // تنسيق التاريخ
        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            const date = new Date(dateString);
            return isNaN(date) ? 'غير محدد' : date.toLocaleDateString('ar-MA');
        }

        // تنسيق الجنس
        function formatGender(gender) {
            return gender === 'male' ? 'ذكر' : gender === 'female' ? 'أنثى' : sanitizeInput(gender) || 'غير محدد';
        }

        // تنسيق رقم الهاتف
        function formatPhoneNumber(phone) {
            if (!phone || !phone.match(/^\+212[5-7][0-9]{8}$/)) return sanitizeInput(phone) || 'غير محدد';
            return `${phone.slice(0, 4)}-${phone.slice(4, 7)}-${phone.slice(7)}`;
        }

        // عرض تفاصيل المستخدم
        function showUserDetails(user) {
            const modalBodyContent = document.getElementById('modalBodyContent');
            modalBodyContent.innerHTML = `
                <img src="${user.personalPhoto}" alt="الصورة" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
                <div class="detail-item"><i class="fas fa-user"></i><strong>الاسم الكامل:</strong> ${user.fullName}</div>
                <div class="detail-item"><i class="fas fa-calendar-alt"></i><strong>تاريخ الميلاد:</strong> ${user.birthDate}</div>
                <div class="detail-item"><i class="fas fa-venus-mars"></i><strong>الجنس:</strong> ${formatGender(user.gender)}</div>
                <div class="detail-item"><i class="fas fa-map-marker-alt"></i><strong>العنوان:</strong> ${user.address}</div>
                <div class="detail-item"><i class="fas fa-phone"></i><strong>رقم الهاتف:</strong> <span class="phone-number">${formatPhoneNumber(user.phoneNumber)}</span></div>
                <div class="detail-item"><i class="fas fa-id-card"></i><strong>رقم البطاقة:</strong> ${user.idNumber}</div>
                <div class="detail-item"><i class="fas fa-calendar-check"></i><strong>تاريخ الإصدار:</strong> ${user.issueDate}</div>
                <div class="detail-item"><i class="fas fa-calendar-times"></i><strong>تاريخ الانتهاء:</strong> ${user.expiryDate}</div>
                <div class="detail-item"><i class="fas fa-clock"></i><strong>تاريخ الإدخال:</strong> ${user.createdAt}</div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        }

        // تعديل المستخدم
        function editUser(docId) {
            const user = allUsers.find(u => u.docId === docId);
            if (!user) {
                alert('لم يتم العثور على المستخدم!');
                return;
            }
            document.getElementById('edit-doc-id').value = docId;
            document.getElementById('edit-fullName').value = user.fullName;
            document.getElementById('edit-birthDate').value = user.birthDateRaw || '';
            document.getElementById('edit-gender').value = user.gender || 'male';
            document.getElementById('edit-address').value = user.address;
            document.getElementById('edit-phoneNumber').value = user.phoneNumber;
            document.getElementById('edit-idNumber').value = user.idNumber;
            document.getElementById('edit-issueDate').value = user.issueDateRaw || '';
            document.getElementById('edit-expiryDate').value = user.expiryDateRaw || '';
            document.getElementById('edit-personalPhoto').value = user.personalPhoto;
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        // حفظ التعديلات
        async function saveEdit() {
            const docId = document.getElementById('edit-doc-id').value;
            const fullName = sanitizeInput(document.getElementById('edit-fullName').value);
            const birthDate = document.getElementById('edit-birthDate').value;
            const gender = document.getElementById('edit-gender').value;
            const address = sanitizeInput(document.getElementById('edit-address').value);
            const phoneNumber = sanitizeInput(document.getElementById('edit-phoneNumber').value);
            const idNumber = sanitizeInput(document.getElementById('edit-idNumber').value);
            const issueDate = document.getElementById('edit-issueDate').value;
            const expiryDate = document.getElementById('edit-expiryDate').value;
            const personalPhoto = sanitizeInput(document.getElementById('edit-personalPhoto').value);

            // التحقق من الحقول
            if (!docId || !fullName || !birthDate || !gender || !address || !phoneNumber || !idNumber || !issueDate || !expiryDate || !personalPhoto) {
                alert('يرجى ملء جميع الحقول المطلوبة!');
                return;
            }

            try {
                // التحقق مما إذا كان رقم البطاقة الجديد موجود مسبقًا (في حال تغييره)
                const oldUser = allUsers.find(u => u.docId === docId);
                if (oldUser.idNumber !== idNumber) {
                    const idCheck = await getDoc(doc(db, 'national_id_data', idNumber));
                    if (idCheck.exists()) {
                        alert('رقم البطاقة الجديد موجود مسبقًا! يرجى اختيار رقم آخر.');
                        return;
                    }
                    // حذف المستند القديم وإنشاء مستند جديد برقم البطاقة الجديد
                    await deleteDoc(doc(db, 'national_id_data', docId));
                    await setDoc(doc(db, 'national_id_data', idNumber), {
                        fullName,
                        birthDate,
                        gender,
                        address,
                        phoneNumber,
                        idNumber,
                        issueDate,
                        expiryDate,
                        personalPhoto,
                        createdAt: oldUser.createdAtRaw || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    // تحديث المستند الحالي إذا لم يتغير رقم البطاقة
                    await updateDoc(doc(db, 'national_id_data', docId), {
                        fullName,
                        birthDate,
                        gender,
                        address,
                        phoneNumber,
                        idNumber,
                        issueDate,
                        expiryDate,
                        personalPhoto,
                        updatedAt: new Date().toISOString()
                    });
                }

                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                document.getElementById('save-user-name').textContent = fullName;
                const saveModal = new bootstrap.Modal(document.getElementById('saveConfirmModal'));
                saveModal.show();

                fetchUsers(); // تحديث البيانات
            } catch (error) {
                console.error('خطأ في حفظ التعديلات:', error);
                alert('حدث خطأ أثناء حفظ التعديلات: ' + error.message);
            }
        }

        // تأكيد الحذف
        function confirmDeleteUser(docId) {
            const user = allUsers.find(u => u.docId === docId);
            if (!user) return;
            deleteId = docId;
            document.getElementById('delete-user-name').textContent = user.fullName;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        // حذف المستخدم
        async function deleteUser() {
            if (!deleteId) return;
            try {
                await deleteDoc(doc(db, 'national_id_data', deleteId));
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                deleteId = null;
                fetchUsers(); // تحديث البيانات بعد الحذف
            } catch (error) {
                console.error('خطأ في الحذف:', error);
                alert('حدث خطأ أثناء الحذف: ' + error.message);
            }
        }

        // جلب البيانات
        async function fetchUsers(searchQuery = '', genderFilter = '', page = 1) {
            loadingSpinner.style.display = 'block';
            errorMessage.style.display = 'none';
            noResults.style.display = 'none';
            userList.innerHTML = '';

            try {
                const querySnapshot = await getDocs(collection(db, 'national_id_data'));
                allUsers = [];

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    allUsers.push({
                        docId: doc.id,
                        personalPhoto: data.personalPhoto || 'https://via.placeholder.com/90',
                        fullName: sanitizeInput(data.fullName) || 'غير محدد',
                        birthDate: formatDate(data.birthDate),
                        birthDateRaw: data.birthDate || '',
                        gender: data.gender || 'غير محدد',
                        address: sanitizeInput(data.address) || 'غير محدد',
                        idNumber: sanitizeInput(data.idNumber) || 'غير محدد',
                        phoneNumber: sanitizeInput(data.phoneNumber) || 'غير محدد',
                        issueDate: formatDate(data.issueDate),
                        issueDateRaw: data.issueDate || '',
                        expiryDate: formatDate(data.expiryDate),
                        expiryDateRaw: data.expiryDate || '',
                        createdAt: data.createdAt ? new Date(data.createdAt).toLocaleString('ar-MA') : 'غير محدد',
                        createdAtRaw: data.createdAt || ''
                    });
                });

                const filteredUsers = filterUsers(searchQuery, genderFilter);
                updateStats(filteredUsers);

                const sortedUsers = sortUsers(filteredUsers);
                const startIdx = (page - 1) * itemsPerPage;
                const paginatedUsers = sortedUsers.slice(startIdx, startIdx + itemsPerPage);

                if (paginatedUsers.length === 0) {
                    noResults.style.display = 'block';
                } else {
                    paginatedUsers.forEach((user, index) => {
                        const isExpired = new Date(user.expiryDateRaw) < new Date();
                        const row = document.createElement('tr');
                        row.classList.add('animate__animated', 'animate__fadeInUp', isExpired ? 'expired' : 'active');
                        row.style.animationDelay = `${index * 0.05}s`;
                        row.innerHTML = `
                            <td data-label="الصورة"><img src="${user.personalPhoto}" alt="الصورة" loading="lazy" onerror="this.src='https://via.placeholder.com/90'"></td>
                            <td data-label="الاسم الكامل">${user.fullName}</td>
                            <td data-label="تاريخ الميلاد">${user.birthDate}</td>
                            <td data-label="الجنس">${formatGender(user.gender)}</td>
                            <td data-label="العنوان">${user.address}</td>
                            <td data-label="رقم البطاقة">${user.idNumber}</td>
                            <td data-label="رقم الهاتف"><span class="phone-number">${formatPhoneNumber(user.phoneNumber)}</span></td>
                            <td data-label="تاريخ الإصدار">${user.issueDate}</td>
                            <td data-label="تاريخ الانتهاء">${user.expiryDate}</td>
                            <td data-label="تاريخ الإدخال">${user.createdAt}</td>
                            <td data-label="الحالة">${isExpired ? 'منتهية' : 'سارية'}</td>
                            <td data-label="الإجراءات">
                                <button class="btn btn-sm btn-primary view-details"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-success edit-user"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-user"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        row.querySelector('.view-details').addEventListener('click', () => showUserDetails(user));
                        row.querySelector('.edit-user').addEventListener('click', () => editUser(user.docId));
                        row.querySelector('.delete-user').addEventListener('click', () => confirmDeleteUser(user.docId));
                        userList.appendChild(row);
                    });
                }

                generatePagination(sortedUsers.length, page);
            } catch (error) {
                console.error('خطأ في جلب البيانات:', error);
                errorMessage.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // تصفية المستخدمين
        function filterUsers(searchQuery, genderFilter) {
            const searchTerm = sanitizeInput(searchQuery).toLowerCase();
            const genderTerm = genderFilter.toLowerCase();
            const statusFilter = filterStatus.value;

            return allUsers.filter(user => {
                const isExpired = new Date(user.expiryDateRaw) < new Date();
                return (user.fullName.toLowerCase().includes(searchTerm) ||
                        user.idNumber.toLowerCase().includes(searchTerm) ||
                        user.phoneNumber.toLowerCase().includes(searchTerm)) &&
                       (genderTerm === '' || user.gender.toLowerCase() === genderTerm) &&
                       (statusFilter === '' || (statusFilter === 'active' && !isExpired) || (statusFilter === 'expired' && isExpired));
            });
        }

        // ترتيب المستخدمين
        function sortUsers(users) {
            return users.sort((a, b) => {
                const valA = [a.personalPhoto, a.fullName, a.birthDate, a.gender, a.address, a.idNumber, a.phoneNumber, a.issueDate, a.expiryDate, a.createdAt][sortColumn];
                const valB = [b.personalPhoto, b.fullName, b.birthDate, b.gender, b.address, b.idNumber, b.phoneNumber, b.issueDate, b.expiryDate, b.createdAt][sortColumn];
                return sortDirection * (valA > valB ? 1 : -1);
            });
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection *= -1;
            } else {
                sortColumn = column;
                sortDirection = 1;
            }
            fetchUsers(searchInput.value, filterGender.value, currentPage);
        }

        // تحديث الإحصائيات
        function updateStats(filteredUsers) {
            const total = filteredUsers.length;
            const active = filteredUsers.filter(u => new Date(u.expiryDateRaw) >= new Date()).length;
            const expired = total - active;
            totalCards.textContent = total;
            activeCards.textContent = active;
            expiredCards.textContent = expired;
        }

        // إنشاء الترقيم
        function generatePagination(totalItems, currentPage) {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                pageItem.classList.add('page-item');
                if (i === currentPage) pageItem.classList.add('active');
                pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageItem.querySelector('.page-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    fetchUsers(searchInput.value, filterGender.value, i);
                });
                paginationControls.appendChild(pageItem);
            }
        }

        // تصدير إلى Excel
        exportExcelBtn.addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet(allUsers.map(user => ({
                'الاسم الكامل': user.fullName,
                'تاريخ الميلاد': user.birthDate,
                'الجنس': formatGender(user.gender),
                'العنوان': user.address,
                'رقم البطاقة': user.idNumber,
                'رقم الهاتف': formatPhoneNumber(user.phoneNumber),
                'تاريخ الإصدار': user.issueDate,
                'تاريخ الانتهاء': user.expiryDate,
                'تاريخ الإدخال': user.createdAt
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "National_ID_Data");
            XLSX.writeFile(wb, "national_id_data.xlsx");
        });

        // طباعة الجدول
        printBtn.addEventListener('click', () => {
            const printContent = document.querySelector('.table-responsive').outerHTML;
            const win = window.open('', '', 'height=500,width=800');
            win.document.write('<html><head><title>طباعة</title>');
            win.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            win.document.write('<style>body { font-family: "Cairo", sans-serif; direction: rtl; } .expired { background-color: #fee2e2; } .active { background-color: #e6ffe6; } img { width: 80px; height: 80px; }</style>');
            win.document.write('</head><body>');
            win.document.write(printContent);
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        });

        // تحديث البيانات
        refreshBtn.addEventListener('click', () => fetchUsers(searchInput.value, filterGender.value, currentPage));

        // إضافة مستمعي الأحداث
        saveEditBtn.addEventListener('click', saveEdit);
        confirmDeleteBtn.addEventListener('click', deleteUser);

        // البحث والتصفية
        searchInput.addEventListener('input', debounce(() => fetchUsers(searchInput.value, filterGender.value, 1), 100));
        filterGender.addEventListener('change', () => fetchUsers(searchInput.value, filterGender.value, 1));
        filterStatus.addEventListener('change', () => fetchUsers(searchInput.value, filterGender.value, 1));

        // دالة التأخير (debounce)
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        // جلب البيانات عند التحميل
        fetchUsers();
    </script>
</body>
</html>